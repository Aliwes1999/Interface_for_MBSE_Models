{% extends "base.html" %} {% block title %}KI-Agent für {{ project.name }}{%
endblock %} {% block content %}
<div class="container mt-5">
  <div class="mb-3">
    <a
      href="{{ url_for('main.manage_project', project_id=project.id) }}"
      class="btn btn-secondary"
    >
      <i class="bi bi-arrow-left"></i> Zurück zum Projekt
    </a>
  </div>

  <h1 class="mb-4">KI-Agent für Projekt: {{ project.name }}</h1>
  <p class="mb-4">
    Generiere Requirements mit Hilfe von KI. Gib eine Beschreibung ein oder lade
    eine bestehende Excel-Datei hoch.
  </p>

  <div class="card">
    <div class="card-body">
      <form id="agent-form">
        <div class="mb-3">
          <label for="produktsystem" class="form-label">Produktsystem</label>
          <input
            type="text"
            class="form-control"
            id="produktsystem"
            name="produktsystem"
            placeholder="Gib hier den Namen des Produktsystems ein (z. B. „Montagesystem A“)."
          />
          <small class="form-text text-muted">
            Optional: Auf welches Produktsystem beziehen sich die Anforderungen?
          </small>
        </div>


    <div class="mb-3">
      <label for="system_description" class="form-label">Systembeschreibung (optional)</label>
      <textarea
        class="form-control"
        id="system_description"
        name="system_description"
        rows="5"
        placeholder="Beschreibe das Produktsystem, seine Funktionen oder seinen Einsatzbereich."
      ></textarea>
      <small class="form-text text-muted">
        Gib eine allgemeine Beschreibung des Produktsystems an. Diese Informationen helfen der KI,
        präzisere und besser zugeschnittene Anforderungen zu generieren. Wenn du keine
        Beschreibung angibst, werden allgemeine Requirements erstellt.
      </small>
    </div>


        <div class="mb-3">
          <label class="form-label">Anzahl der Anforderungen</label>
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <select class="form-select" id="amount_mode" name="amount_mode">
                <option value="none" selected>none (automatisch)</option>
                <option value="exact">exact (GENAU)</option>
                <option value="min">min (MINDESTENS)</option>
                <option value="max">max (HÖCHSTENS)</option>
              </select>
            </div>
            <div class="col-auto">
              <input type="number" min="1" class="form-control" id="amount_value" name="amount_value" placeholder="Wert" value="5" />
            </div>
            <div class="col-auto">
              <small class="text-muted">Regeln werden exakt im Prompt angewendet (siehe Vorgaben).</small>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Tabellenspalten</label>
          <div id="custom-columns-container">
            <!-- Default columns that are always included -->
            <div class="input-group mb-2">
              <input
                type="text"
                class="form-control column-input"
                value="title"
                readonly
              />
              <span class="input-group-text bg-primary text-white"
                >Standard</span
              >
            </div>
            <div class="input-group mb-2">
              <input
                type="text"
                class="form-control column-input"
                value="description"
                readonly
              />
              <span class="input-group-text bg-primary text-white"
                >Standard</span
              >
            </div>
            <div class="input-group mb-2">
              <input
                type="text"
                class="form-control column-input"
                value="category"
                readonly
              />
              <span class="input-group-text bg-primary text-white"
                >Standard</span
              >
            </div>
          </div>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            id="add-column-btn"
          >
            <i class="bi bi-plus-circle"></i> Spalte hinzufügen
          </button>
          <small class="form-text text-muted d-block mt-2"
            >Füge zusätzliche Spalten hinzu, die die KI ausfüllen soll (z.B.
            "Priorität", "Kosten", "Verantwortlich", "Farbe").</small
          >
        </div>

        <div class="mb-3">
          <label for="ai_model" class="form-label">
            <i class="bi bi-cpu"></i> KI-Modell wählen
          </label>
          <select class="form-select" id="ai_model" name="ai_model">
            {% for model in available_models %}
            <option
              value="{{ model.id }}"
              {%
              if
              loop.first
              %}selected{%
              endif
              %}
            >
              {{ model.name }} - {{ model.description }}
            </option>
            {% endfor %}
          </select>
          <div class="form-text">
            Wähle das KI-Modell für die Generierung.
          </div>
        </div>

        <button type="submit" class="btn btn-primary" id="generate-btn">
          <span
            class="spinner-border spinner-border-sm d-none"
            role="status"
            aria-hidden="true"
          ></span>
          Generieren
        </button>
      </form>

      <div id="response-message" class="mt-3 d-none"></div>
    </div>
  </div>
</div>

<script>
  // Handle adding custom columns
  let columnCounter = 0;
  document
    .getElementById("add-column-btn")
    .addEventListener("click", function () {
      columnCounter++;
      const container = document.getElementById("custom-columns-container");
      const newColumn = document.createElement("div");
      newColumn.className = "input-group mb-2";
      newColumn.id = `column-${columnCounter}`;
      newColumn.innerHTML = `
      <input type="text" class="form-control column-input" placeholder="Spaltenname eingeben..." />
      <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
        <i class="bi bi-trash"></i>
      </button>
    `;
      container.appendChild(newColumn);
    });

  // Handle form submission
  document
    .getElementById("agent-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const btn = document.getElementById("generate-btn");
      const spinner = btn.querySelector(".spinner-border");
      const messageDiv = document.getElementById("response-message");

      // Disable button and show spinner
      btn.disabled = true;
      spinner.classList.remove("d-none");
      messageDiv.classList.add("d-none");

      // Collect form data
      const formData = new FormData(e.target);
      const maschine = formData.get("maschine") || "";
      const userDescription = formData.get("user_description") || "";
      const aiModel = formData.get("ai_model") || "";

      // Collect ALL columns (standard + custom)
      const allColumns = [];
      document.querySelectorAll(".column-input").forEach((input) => {
        const value = input.value.trim();
        if (value) {
          allColumns.push(value);
        }
      });

      // Combine all user inputs into the prompt content that will be sent to the AI.
      // We include the Maschine and the Beschreibung in the user_description so
      // that the prompt contains everything the user entered.
      let combinedDescription = "";
      if (maschine && maschine.trim()) {
        combinedDescription += `Maschine: ${maschine.trim()}\n`;
      }
      if (userDescription && userDescription.trim()) {
        combinedDescription += `Beschreibung: ${userDescription.trim()}\n`;
      }

      // Read amount mode and value and append strict rules to the prompt.
      const amountMode = (formData.get("amount_mode") || "none").toString();
      let amountValueRaw = formData.get("amount_value");
      let amountValue = parseInt(amountValueRaw, 10);
      if (isNaN(amountValue) || amountValue < 1) {
        amountValue = 5; // default
      }

      // Compute a small buffer for the 'min' rule. Use 20% rounded down, at least 1.
      const buffer = Math.max(1, Math.floor(amountValue * 0.2));
      const amount_value_plus_buffer = amountValue + buffer;

      // Build exact instructions according to the 4 rules and append them
      // EXACTLY as specified by the user (German text kept concise).
      let amountInstruction = "";
      if (amountMode === "exact") {
        amountInstruction = `Erzeuge GENAU ${amountValue} Requirements.`;
      } else if (amountMode === "min") {
        amountInstruction = `Erzeuge mindestens ${amountValue} Requirements. Erzeuge nach Möglichkeit zwischen ${amountValue} und ${amount_value_plus_buffer} Requirements.`;
      } else if (amountMode === "max") {
        amountInstruction = `Erzeuge höchstens ${amountValue} Requirements. Erzeuge eine sinnvolle Anzahl <= ${amountValue}.`;
      } else {
        amountInstruction = `Wähle selbst eine sinnvolle Anzahl an Requirements (typischerweise zwischen 5 und 20).`;
      }

      // Append the instruction to the combined description so the model follows the rules.
      if (amountInstruction) {
        combinedDescription += `\nAnzahl-Regel: ${amountInstruction}\n`;
      }

      const payload = new FormData();
      payload.append("user_description", combinedDescription);
      // Send empty inputs object to maintain backend compatibility
      payload.append("inputs", JSON.stringify([]));
      // Send ALL columns to backend (standard + custom)
      if (allColumns.length > 0) {
        payload.append("new_columns", JSON.stringify(allColumns));
      }
      // Send selected AI model
      if (aiModel) {
        payload.append("ai_model", aiModel);
      }

      // Send POST request
      fetch("/agent/generate/{{ project.id }}", {
        method: "POST",
        credentials: "same-origin",
        body: payload,
      })
        .then((response) => response.json())
        .then((result) => {
          messageDiv.classList.remove("d-none");

          if (result.ok) {
            // Success
            messageDiv.className = "alert alert-success mt-3";
            messageDiv.innerHTML = `
        <strong>Erfolg!</strong> ${result.count} Requirement(s) wurden erfolgreich generiert und gespeichert.
        <br>Sie werden in Kürze zum Projekt weitergeleitet...
      `;

            // Redirect after 2 seconds
            setTimeout(function () {
              window.location.href = result.redirect;
            }, 2000);
          } else {
            // Error from backend
            messageDiv.className = "alert alert-danger mt-3";
            messageDiv.innerHTML = `<strong>Fehler:</strong> ${result.error}`;
            btn.disabled = false;
            spinner.classList.add("d-none");
          }
        })
        .catch((error) => {
          // Network or parsing error
          messageDiv.classList.remove("d-none");
          messageDiv.className = "alert alert-danger mt-3";
          messageDiv.innerHTML = `<strong>Netzwerkfehler:</strong> ${error.message}`;
          btn.disabled = false;
          spinner.classList.add("d-none");
        });
    });
</script>
{% endblock %}
