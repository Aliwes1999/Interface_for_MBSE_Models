{% extends "base.html" %} {% block title %}KI-Agent für {{ project.name }}{%
endblock %} {% block content %}
<div class="container mt-5">
  <div class="mb-3">
    <a
      href="{{ url_for('main.manage_project', project_id=project.id) }}"
      class="btn btn-secondary"
    >
      <i class="bi bi-arrow-left"></i> Zurück zum Projekt
    </a>
  </div>

  <h1 class="mb-4">KI-Agent für Projekt: {{ project.name }}</h1>
  <p class="mb-4">
    Generiere Requirements mit Hilfe von KI. Gib eine optionale Beschreibung und
    zusätzliche Key-Value-Paare ein.
  </p>

  <div class="card">
    <div class="card-body">
      <form id="agent-form">
        <div class="mb-3">
          <label for="user_description" class="form-label"
            >User-Beschreibung (optional)</label
          >
          <textarea
            class="form-control"
            id="user_description"
            name="user_description"
            rows="5"
            placeholder="Beschreibe die Requirements, die du generieren möchtest. Dieses Feld ist optional."
          ></textarea>
          <small class="form-text text-muted"
            >Gib eine allgemeine Beschreibung der gewünschten Requirements ein.
            Wenn du keine Beschreibung angibst, werden allgemeine Requirements
            generiert.</small
          >
        </div>

        <div class="mb-3">
          <label class="form-label">Zusätzliche Inputs (Key-Value-Paare)</label>
          <div id="inputs-container">
            <div class="input-group mb-2">
              <input
                type="text"
                class="form-control"
                placeholder="Key"
                name="key[]"
              />
              <input
                type="text"
                class="form-control"
                placeholder="Value"
                name="value[]"
              />
              <button type="button" class="btn btn-outline-danger remove-input">
                Entfernen
              </button>
            </div>
          </div>
          <button type="button" class="btn btn-outline-primary" id="add-input">
            Key-Value-Paar hinzufügen
          </button>
        </div>

        <button type="submit" class="btn btn-primary" id="generate-btn">
          <span
            class="spinner-border spinner-border-sm d-none"
            role="status"
            aria-hidden="true"
          ></span>
          Generieren
        </button>
      </form>

      <div id="response-message" class="mt-3 d-none"></div>
    </div>
  </div>
</div>

<script>
  // Add new key-value pair input
  document.getElementById("add-input").addEventListener("click", function () {
    const container = document.getElementById("inputs-container");
    const div = document.createElement("div");
    div.className = "input-group mb-2";
    div.innerHTML = `
    <input type="text" class="form-control" placeholder="Key" name="key[]">
    <input type="text" class="form-control" placeholder="Value" name="value[]">
    <button type="button" class="btn btn-outline-danger remove-input">Entfernen</button>
  `;
    container.appendChild(div);
  });

  // Remove key-value pair input
  document
    .getElementById("inputs-container")
    .addEventListener("click", function (e) {
      if (e.target.classList.contains("remove-input")) {
        e.target.parentElement.remove();
      }
    });

  // Handle form submission
  document
    .getElementById("agent-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const btn = document.getElementById("generate-btn");
      const spinner = btn.querySelector(".spinner-border");
      const messageDiv = document.getElementById("response-message");

      // Disable button and show spinner
      btn.disabled = true;
      spinner.classList.remove("d-none");
      messageDiv.classList.add("d-none");

      // Collect form data
      const formData = new FormData(e.target);
      const userDescription = formData.get("user_description") || "";

      // Collect key-value pairs as array
      const keys = formData.getAll("key[]");
      const values = formData.getAll("value[]");
      const inputs = [];

      keys.forEach((key, i) => {
        if (key && key.trim() && values[i] && values[i].trim()) {
          inputs.push({
            key: key.trim(),
            value: values[i].trim(),
          });
        }
      });

      // Prepare request data
      const data = {
        user_description: userDescription,
        inputs: inputs,
      };

      // Send POST request
      fetch("/agent/generate/{{ project.id }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "same-origin",
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((result) => {
          messageDiv.classList.remove("d-none");

          if (result.ok) {
            // Success
            messageDiv.className = "alert alert-success mt-3";
            messageDiv.innerHTML = `
        <strong>Erfolg!</strong> ${result.count} Requirement(s) wurden erfolgreich generiert und gespeichert.
        <br>Sie werden in Kürze zum Projekt weitergeleitet...
      `;

            // Redirect after 2 seconds
            setTimeout(function () {
              window.location.href = result.redirect;
            }, 2000);
          } else {
            // Error from backend
            messageDiv.className = "alert alert-danger mt-3";
            messageDiv.innerHTML = `<strong>Fehler:</strong> ${result.error}`;
            btn.disabled = false;
            spinner.classList.add("d-none");
          }
        })
        .catch((error) => {
          // Network or parsing error
          messageDiv.classList.remove("d-none");
          messageDiv.className = "alert alert-danger mt-3";
          messageDiv.innerHTML = `<strong>Netzwerkfehler:</strong> ${error.message}`;
          btn.disabled = false;
          spinner.classList.add("d-none");
        });
    });
</script>
{% endblock %}
