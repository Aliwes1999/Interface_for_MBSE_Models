{% extends "base.html" %} {% block title %}KI-Agent für {{ project.name }}{%
endblock %} {% block content %}
<div class="container mt-5">
  <div class="mb-3">
    <a
      href="{{ url_for('main.manage_project', project_id=project.id) }}"
      class="btn btn-secondary"
    >
      <i class="bi bi-arrow-left"></i> Zurück zum Projekt
    </a>
  </div>

  <h1 class="mb-4">KI-Agent für Projekt: {{ project.name }}</h1>
  <p class="mb-4">
    Generiere Requirements mit Hilfe von KI. Gib eine Beschreibung ein oder lade
    eine bestehende Excel-Datei hoch.
  </p>

  <div class="card">
    <div class="card-body">
      <form id="agent-form">
        <div class="mb-3">
          <label for="maschine" class="form-label">Maschine</label>
          <input type="text" class="form-control" id="maschine" name="maschine"
          placeholder="Gib hier den Maschinennamen oder die Maschine ein (z. B.
          "Maschine A")." />
          <small class="form-text text-muted"
            >Optional: Auf welche Maschine beziehen sich die
            Anforderungen?</small
          >
        </div>

        <div class="mb-3">
          <label for="user_description" class="form-label"
            >User-Beschreibung (optional)</label
          >
          <textarea
            class="form-control"
            id="user_description"
            name="user_description"
            rows="5"
            placeholder="Beschreibe die Requirements, die du generieren möchtest. Dieses Feld ist optional."
          ></textarea>
          <small class="form-text text-muted"
            >Gib eine allgemeine Beschreibung der gewünschten Requirements ein.
            Wenn du keine Beschreibung angibst, werden allgemeine Requirements
            generiert.</small
          >
        </div>

        <div class="mb-3">
          <label for="excel_file" class="form-label"
            >Bestehende Anforderungen hochladen (Excel)</label
          >
          <input
            type="file"
            class="form-control"
            id="excel_file"
            name="excel_file"
            accept=".xlsx,.xls"
          />
          <small class="form-text text-muted"
            >Lade eine bestehende Excel-Tabelle hoch, damit die KI diese
            analysieren und verbessern kann.</small
          >
        </div>

        <button type="submit" class="btn btn-primary" id="generate-btn">
          <span
            class="spinner-border spinner-border-sm d-none"
            role="status"
            aria-hidden="true"
          ></span>
          Generieren
        </button>
      </form>

      <div id="response-message" class="mt-3 d-none"></div>
    </div>
  </div>
</div>

<script>
  // Handle form submission
  document
    .getElementById("agent-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const btn = document.getElementById("generate-btn");
      const spinner = btn.querySelector(".spinner-border");
      const messageDiv = document.getElementById("response-message");

      // Disable button and show spinner
      btn.disabled = true;
      spinner.classList.remove("d-none");
      messageDiv.classList.add("d-none");

      // Collect form data
      const formData = new FormData(e.target);
      const maschine = formData.get("maschine") || "";
      const userDescription = formData.get("user_description") || "";
      const fileInput = document.getElementById("excel_file");

      // Combine all user inputs into the prompt content that will be sent to the AI.
      // We include the Maschine and the Beschreibung in the user_description so
      // that the prompt contains everything the user entered.
      let combinedDescription = "";
      if (maschine && maschine.trim()) {
        combinedDescription += `Maschine: ${maschine.trim()}\n`;
      }
      if (userDescription && userDescription.trim()) {
        combinedDescription += `Beschreibung: ${userDescription.trim()}\n`;
      }

      const payload = new FormData();
      if (fileInput.files[0]) {
        payload.append("excel_file", fileInput.files[0]);
      }
      payload.append("user_description", combinedDescription);
      // Send empty inputs object to maintain backend compatibility
      payload.append("inputs", JSON.stringify([]));

      // Send POST request
      fetch("/agent/generate/{{ project.id }}", {
        method: "POST",
        credentials: "same-origin",
        body: payload,
      })
        .then((response) => response.json())
        .then((result) => {
          messageDiv.classList.remove("d-none");

          if (result.ok) {
            // Success
            messageDiv.className = "alert alert-success mt-3";
            messageDiv.innerHTML = `
        <strong>Erfolg!</strong> ${result.count} Requirement(s) wurden erfolgreich generiert und gespeichert.
        <br>Sie werden in Kürze zum Projekt weitergeleitet...
      `;

            // Redirect after 2 seconds
            setTimeout(function () {
              window.location.href = result.redirect;
            }, 2000);
          } else {
            // Error from backend
            messageDiv.className = "alert alert-danger mt-3";
            messageDiv.innerHTML = `<strong>Fehler:</strong> ${result.error}`;
            btn.disabled = false;
            spinner.classList.add("d-none");
          }
        })
        .catch((error) => {
          // Network or parsing error
          messageDiv.classList.remove("d-none");
          messageDiv.className = "alert alert-danger mt-3";
          messageDiv.innerHTML = `<strong>Netzwerkfehler:</strong> ${error.message}`;
          btn.disabled = false;
          spinner.classList.add("d-none");
        });
    });
</script>
{% endblock %}
